input {
  tcp {
    type => "rsyslog"
    port => 514
  }
}

filter {
  grok {
  #正規化需要的log
  match => {
        "message" =>[
          "devname=\"%{HOSTNAME:devname}\" devid=\"FG3H0E5818905921\" vd=\"%{HOSTNAME:vdom}\" date=%{DATA:date} time=%{TIME:time} logid=\"%{NUMBER:logid}\" type=\"%{DATA:type}\" subtype=\"%{DATA:subtype}\" level=\"%{DATA:level}\" eventtime=%{NUMBER:eventtime} logdesc=\"%{DATA:logdesc}\" action=\"%{DATA:action}\" tunneltype=\"%{DATA:tunneltype}\" tunnelid=%{NUMBER:tunnelid} remip=%{IP:remip} user=\"%{DATA:user}\" group=\"%{DATA:group}\" dst_host=\"%{DATA:dst_host}\" reason=\"%{DATA:reason}\" msg=\"%{DATA:msg}\"",
          "devname=\"%{HOSTNAME:devname}\" devid=\"%{HOSTNAME:devid}\" vd=\"%{HOSTNAME:vdom}\" date=%{DATA:date} time=%{TIME:time} logid=\"%{NUMBER:logid}\" type=\"%{DATA:type}\" subtype=\"%{DATA:subtype}\" level=\"%{DATA:level}\" eventtime=%{NUMBER:eventtime} srcip=%{IP:srcip} srcintf=\"%{DATA:srcintf}\" srcintfrole=\"%{DATA:srcintfrole}\" dstip=%{IP:dstip} dstintf=\"%{DATA:dstintf}\" dstintfrole=\"%{DATA:dstintfrole}\" poluuid=\"%{DATA:poluuid}\" sessionid=%{NUMBER:sessionid} proto=%{NUMBER:proto} action=\"%{DATA:action}\" policyid=%{NUMBER:policyid} policytype=\"%{DATA:policytype}\" service=\"%{DATA:service}\" dstcountry=\"%{DATA:dstcountry}\" srccountry=\"%{DATA:srccountry}\" trandisp=\"%{DATA:trandisp}\" duration=%{NUMBER:duration} sentbyte=%{NUMBER:sentbyte} rcvdbyte=%{NUMBER:rcvdbyte} sentpkt=%{NUMBER:sentpkt} rcvdpkt=%{NUMBER:rcvdpkt} appcat=\"%{DATA:appcat}\" devtype=\"%{DATA:devtype}\" devcategory=\"%{DATA:devcategory}\" mastersrcmac=\"%{MAC:mastersrcmac}\" srcmac=\"%{MAC:srcmac}\" srcserver=%{NUMBER:srcserver} dstdevtype=\"%{DATA:dstdevtype}\" dstdevcategory=\"%{DATA:dstdevcategory}\" masterdstmac=\"%{MAC:masterdstmac}\" dstmac=\"%{MAC:dstmac}\" dstserver=%{NUMBER:dstserver}",
          "devname=\"%{HOSTNAME:devname}\" devid=\"%{HOSTNAME:devid}\" vd=\"%{HOSTNAME:vdom}\" date=%{DATA:date} time=%{TIME:time} logid=\"%{NUMBER:logid}\" type=\"%{DATA:type}\" subtype=\"%{DATA:subtype}\" level=\"%{DATA:level}\" eventtime=%{NUMBER:eventtime} logdesc=\"%{DATA:logdesc}\" action=\"%{DATA:action}\" tunneltype=\"%{DATA:tunneltype}\" tunnelid=%{NUMBER:tunnelid} remip=%{IP:remip} tunnelip=%{IP:tunnelip} user=\"%{DATA:user}\" group=\"%{DATA:group}\" dst_host=\"%{DATA:dst_host}\" reason=\"%{DATA:reason}\"",
          "devname=\"%{HOSTNAME:devname}\" devid=\"%{HOSTNAME:devid}\" vd=\"%{HOSTNAME:vdom}\" date=%{DATA:date} time=%{TIME:time} logid=\"%{NUMBER:logid}\" type=\"%{DATA:type}\" subtype=\"%{DATA:subtype}\" level=\"%{DATA:level}\" eventtime=%{NUMBER:eventtime} logdesc=\"%{DATA:logdesc}\" user=\"%{HOSTNAME:user}\" ui=\"%{DATA:ui}\" action=\"%{DATA:action}\" cfgtid=%{DATA:cfgtid} cfgpath=\"%{DATA:cfgpath}\" cfgobj=\"%{NUMBER:cfgobj}\" cfgattr=\"%{DATA:cfgattr}\" msg=\"%{DATA:msg}\"",
          "devname=\"%{HOSTNAME:devname}\" devid=\"%{HOSTNAME:devid}\" vd=\"%{HOSTNAME:vdom}\" date=%{DATA:date} time=%{TIME:time} logid=\"%{NUMBER:logid}\" type=\"%{DATA:type}\" subtype=\"%{DATA:subtype}\" level=\"%{DATA:level}\" eventtime=%{NUMBER:eventtime} logdesc=\"%{DATA:logdesc}\" user=\"%{HOSTNAME:user}\" ui=\"%{DATA:ui}\" action=\"%{DATA:action}\" cfgtid=%{DATA:cfgtid} cfgpath=\"%{DATA:cfgpath}\" cfgobj=\"%{NUMBER:cfgobj}\" msg=\"%{DATA:msg}\"",
          "devname=\"%{HOSTNAME:devname}\" devid=\"%{HOSTNAME:devid}\" vd=\"%{HOSTNAME:vdom}\" date=%{DATA:date} time=%{TIME:time} logid=\"%{NUMBER:logid}\" type=\"%{DATA:type}\" subtype=\"%{DATA:subtype}\" level=\"%{DATA:level}\" eventtime=%{NUMBER:eventtime} srcip=%{IP:srcip} srcport=%{NUMBER:srcport} srcintf=\"%{DATA:srcintf}\" srcintfrole=\"%{DATA:srcintfrole}\" dstip=%{IP:dstip} dstport=%{NUMBER:dstport} dstintf=\"%{DATA:dstintf}\" dstintfrole=\"%{DATA:dstintfrole}\" poluuid=\"%{DATA:poluuid}\" sessionid=%{NUMBER:sessionid} proto=%{NUMBER:proto} action=\"%{DATA:action}\" user=\"%{DATA:user}\" authserver=\"%{DATA:authserver}\" policyid=%{NUMBER:policyid} policytype=\"%{DATA:policytype}\" service=\"%{DATA:service}\" dstcountry=\"%{DATA:dstcountry}\" srccountry=\"%{DATA:srccountry}\" trandisp=\"%{DATA:trandisp}\" transip=%{IP:transip} transport=%{NUMBER:transport} appid=%{NUMBER:appid} app=\"%{DATA:app}\" appcat=\"%{DATA:appcat}\" apprisk=\"%{DATA:aapprisk}\" applist=\"%{DATA:aaplist}\" duration=%{NUMBER:duration} sentbyte=%{NUMBER:sentbyte} rcvdbyte=%{NUMBER:rcvdbyte} sentpkt=%{NUMBER:sentpkt} rcvdpkt=%{NUMBER:rcvdpkt} wanin=%{NUMBER:wanin} wanout=%{NUMBER:wanout} lanin=%{NUMBER:lanin} lanout=%{NUMBER:lanout} utmaction=\"%{DATA:utmaction}\" countapp=%{NUMBER:countapp} devtype=\"%{DATA:devtype}\" devcategory=\"%{DATA:devcategory}\" mastersrcmac=\"%{MAC:mastersrcmac}\" srcmac=\"%{MAC:srcmac}\" srcserver=%{NUMBER:srcserver}",
          "devname=\"%{HOSTNAME:devname}\" devid=\"%{HOSTNAME:devid}\" vd=\"%{HOSTNAME:vdom}\" date=%{DATA:date} time=%{TIME:time} logid=\"%{NUMBER:logid}\" type=\"%{DATA:type}\" subtype=\"%{DATA:subtype}\" level=\"%{DATA:level}\" eventtime=%{NUMBER:eventtime} appid=%{NUMBER:appid} user=\"%{DATA:user}\" authserver=\"%{DATA:authserver}\" srcip=%{IP:srcip} dstip=%{IP:dstip} srcport=%{NUMBER:srcport} dstport=%{NUMBER:dstport} srcintf=\"%{DATA:srcintf}\" srcintfrole=\"%{DATA:srcintfrole}\" dstintf=\"%{DATA:dstintf}\" dstintfrole=\"%{DATA:dstintfrole}\" proto=%{NUMBER:proto} service=\"%{DATA:service}\" direction=\"%{DATA:direction}\" policyid=%{NUMBER:policyid} sessionid=%{NUMBER:sessionid} applist=\"%{DATA:aaplist}\" appcat=\"%{DATA:appcat}\" app=\"%{DATA:app}\" action=\"%{DATA:action}\" hostname=\"%{DATA:hostname}\" incidentserialno=%{NUMBER:incidentserialno} url=\"%{DATA:url}\" msg=\"%{DATA:msg}\" apprisk=\"%{DATA:aapprisk}\" scertcname=\"%{DATA:scertcname}\"",
          "devname=\"%{HOSTNAME:devname}\" devid=\"%{HOSTNAME:devid}\" vd=\"%{HOSTNAME:vdom}\" date=%{DATA:date} time=%{TIME:time} logid=\"%{NUMBER:logid}\" type=\"%{DATA:type}\" subtype=\"%{DATA:subtype}\" level=\"%{DATA:level}\" eventtime=%{NUMBER:eventtime} srcip=%{IP:srcip} srcname=\"%{DATA:srcname}\" srcport=%{NUMBER:srcport} srcintf=\"%{DATA:srcintf}\" srcintfrole=\"%{DATA:srcintfrole}\" dstip=%{IP:dstip} dstport=%{NUMBER:dstport} dstintf=\"%{DATA:dstintf}\" dstintfrole=\"%{DATA:dstintfrole}\" sessionid=%{NUMBER:sessionid} proto=%{NUMBER:proto} action=\"%{DATA:action}\" policyid=%{NUMBER:policyid} policytype=\"%{DATA:policytype}\" service=\"%{DATA:service}\" dstcountry=\"%{DATA:dstcountry}\" srccountry=\"%{DATA:srccountry}\" trandisp=\"%{DATA:trandisp}\" duration=%{NUMBER:duration} sentbyte=%{NUMBER:sentbyte} rcvdbyte=%{NUMBER:rcvdbyte} sentpkt=%{NUMBER:sentpkt} appcat=\"%{DATA:appcat}\" devtype=\"%{DATA:devtype}\" devcategory=\"%{DATA:devcategory}\" mastersrcmac=\"%{MAC:mastersrcmac}\" srcmac=\"%{MAC:srcmac}\" srcserver=%{NUMBER:srcserver}",
          "devname=\"%{HOSTNAME:devname}\" devid=\"%{HOSTNAME:devid}\" vd=\"%{HOSTNAME:vdom}\" date=%{DATA:date} time=%{TIME:time} logid=\"%{NUMBER:logid}\" type=\"%{DATA:type}\" subtype=\"%{DATA:subtype}\" level=\"%{DATA:level}\" eventtime=%{NUMBER:eventtime} severity=\"%{DATA:severity}\" srcip=%{IP:srcip} srccountry=\"%{DATA:srccountryy}\" dstip=%{IP:dstip} srcintf=\"%{DATA:srcintf}\" srcintfrole=\"%{DATA:srcintfrole}\" dstintf=\"%{DATA:dstintf}\" dstintfrole=\"%{DATA:dstintfrole}\" sessionid=%{NUMBER:sessionid} action=\"%{DATA:action}\" proto=%{NUMBER:proto} service=\"%{DATA:service}\" policyid=%{NUMBER:policyid} attack=\"%{DATA:attack}\" srcport=%{NUMBER:srcport} dstport=%{NUMBER:dstport} hostname=\"%{DATA:hostname}\" url=\"%{DATA:url}\" direction=\"%{DATA:direction}\" attackid=%{NUMBER:attackid} profile=\"%{DATA:profile}\" ref=\"%{DATA:ref}\" incidentserialno=%{NUMBER:incidentserialno} msg=\"%{DATA:msg}\" crscore=%{NUMBER:crscore} crlevel=\"%{DATA:crlevel}\"",
          "devname=\"%{HOSTNAME:devname}\" devid=\"%{HOSTNAME:devid}\" vd=\"%{HOSTNAME:vdom}\" date=%{DATA:date} time=%{TIME:time} logid=\"%{NUMBER:logid}\" type=\"%{DATA:type}\" subtype=\"%{DATA:subtype}\" level=\"%{DATA:level}\" eventtime=%{NUMBER:eventtime} severity=\"%{DATA:severity}\" srcip=%{IP:srcip} srccountry=\"%{DATA:srccountryy}\" dstip=%{IP:dstip} srcintf=\"%{DATA:srcintf}\" srcintfrole=\"%{DATA:srcintfrole}\" dstintf=\"%{DATA:dstintf}\" dstintfrole=\"%{DATA:dstintfrole}\" sessionid=%{NUMBER:sessionid} action=\"%{DATA:action}\" proto=%{NUMBER:proto} service=\"%{DATA:service}\" policyid=%{NUMBER:policyid} attack=\"%{DATA:attack}\" srcport=%{NUMBER:srcport} dstport=%{NUMBER:dstport} direction=\"%{DATA:direction}\" attackid=%{NUMBER:attackid} profile=\"%{DATA:profile}\" ref=\"%{DATA:ref}\" incidentserialno=%{NUMBER:incidentserialno} msg=\"%{DATA:msg}\" crscore=%{NUMBER:crscore} crlevel=\"%{DATA:crlevel}\"",
          "devname=\"%{HOSTNAME:devname}\" devid=\"%{HOSTNAME:devid}\" vd=\"%{HOSTNAME:vdom}\" date=%{DATA:date} time=%{TIME:time} logid=\"%{NUMBER:logid}\" type=\"%{DATA:type}\" subtype=\"%{DATA:subtype}\" level=\"%{DATA:level}\" eventtime=%{NUMBER:eventtime} logdesc=\"%{DATA:logdesc}\" sn=\"%{DATA:sn}\" user=\"%{DATA:user}\" ui=\"%{DATA:ui}\" method=\"%{DATA:umethod}\" srcip=%{IP:srcip} dstip=%{IP:dstip} action=\"%{DATA:action}\" status=\"%{DATA:status}\" reason=\"%{DATA:reason}\" msg=\"%{DATA:msg}\""
        ]
  }
  #用來觀察log正規化後存入ES所花費的時間
  add_tag => [ "%{+YYYY-MM-dd HH:mm:ss}" ]
  #移除原始內容，以減省ES空間
  remove_field => [ "message" ]
  }
  #將沒有match的log直接丟棄
  if "_grokparsefailure" in [tags] {
    drop {}
  }

  mutate {
    add_field => { "log_date" => "%{date} %{time}" }
  }

  date {
    match => ["log_date", "yyyy-MM-dd HH:mm:ss"]
    timezone => "Etc/GMT-8"
  }

  geoip {
    source => "remip"
    database => "/usr/share/logstash-7.6.0/config/GeoLite2-City.mmdb"
  }

}


output {
  elasticsearch {
    hosts => ["http://10.0.99.101:9200"]
    user => 'elastic'
    password => 'umec@123'
    action => "index"
    index => "firewall-syslog-%{+YYYY.MM.dd}"
  }
}

#output {
#  stdout {
#    codec => rubydebug{ }
#  }
#}